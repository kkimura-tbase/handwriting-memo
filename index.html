<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>手書きメモ（PDF注釈・配布・自動保存）</title>
<link rel="icon" href="data:,">
<style>
  :root{ --bg:#f7f7f9; --bd:#dcdfe3; --chip:#eef3ff; --accent:#4c7dff; --text:#1a1a1a; }
  html,body{height:100%;margin:0;color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Helvetica,Arial,sans-serif}
  .app{display:grid;grid-template-rows:auto auto 1fr;height:100%;background:#fff}
  .bar{display:flex;align-items:center;gap:.5rem;padding:.55rem .7rem;border-bottom:1px solid var(--bd);background:var(--bg);flex-wrap:wrap}
  .bar .group{display:flex;align-items:center;gap:.4rem;padding:.25rem .35rem;background:#fff;border:1px solid var(--bd);border-radius:.6rem}
  .bar .group .sep{width:1px;height:1.25rem;background:var(--bd);margin:0 .1rem}
  .btn{background:#fff;border:1px solid var(--bd);border-radius:.5rem;padding:.35rem .55rem;cursor:pointer;line-height:1}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.active{background:#e8f0fe;border-color:#6a9bff;box-shadow:0 0 0 2px #cfe0ff inset}
  .chip{display:inline-flex;align-items:center;gap:.35rem;background:var(--chip);border:1px solid #cfe0ff;border-radius:999px;padding:.2rem .5rem;font-size:.9rem}
  .label{font-size:.92rem;color:#555}
  #stageWrap{position:relative;height:100%;min-height:360px;background:#fff;overflow:auto;touch-action: pan-x pan-y;}
  canvas{position:absolute;inset:0;width:100%;height:100%;touch-action:none;display:block}
  #pdfLayer{z-index:0}
  #inkLayer{z-index:1}
  #textLayer{z-index:2;position:absolute;inset:0;pointer-events:none}
  .palette button{width:24px;height:24px;border-radius:50%;padding:0;border:2px solid #ccc;cursor:pointer}
  .palette button.sel{box-shadow:0 0 0 3px #444 inset;border-color:#222}
  .textbox{position:absolute;min-width:40px;min-height:24px;padding:2px 4px;outline:none;border:1px dashed transparent;
           white-space:pre-wrap;word-break:break-word;background:transparent;cursor:text;user-select:text}
  .textbox.sel{border-color:#6a9bff;box-shadow:0 0 0 2px #cfe0ff inset;background:rgba(255,255,255,.2)}
  .grabbing{cursor:grabbing}
  .status{display:flex;align-items:center;gap:.5rem;margin-left:auto}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.saving{background:#f4c430}
  .dot.saved{background:#10b981}
  .dot.error{background:#ef4444}
  .zoom{display:flex;gap:.25rem}
  dialog{border:1px solid var(--bd);border-radius:.8rem;padding:1rem;max-width:min(720px,calc(100vw - 2rem))}
  dialog::backdrop{ background:rgba(0,0,0,.15); }
  dialog form{display:grid;gap:.7rem}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.6rem}
  input[type="text"],input[type="number"]{border:1px solid var(--bd);border-radius:.5rem;padding:.4rem .5rem}
  textarea{width:100%;height:220px;border:1px solid var(--bd);border-radius:.5rem;padding:.5rem}
  menu{display:flex;gap:.5rem;justify-content:flex-end;margin:0;padding:0}
  .warn{color:#b00}
  .hint{font-size:.85rem;color:#666;border:none;background:transparent}
  @media (max-width:780px){ .row3{grid-template-columns:1fr 1fr} }
</style>
</head>
<body>
<div class="app">
  <!-- 上段 -->
  <div class="bar" id="barTop">
    <div class="group">
      <button id="uploadPdfBtn" class="btn">📤 公開（GitHub）</button>
      <input id="uploadPdfFile" type="file" accept="application/pdf" style="display:none">
      <div class="sep"></div>
      <button id="openPdfUrlBtn" class="btn">🌐 URL読込</button>
      <button id="copyShareBtn" class="btn">🔗 共有リンク</button>
      <button id="batchLinksBtn" class="btn">🔢 一括</button>
    </div>
    <div class="group">
      <span class="chip">👩‍🏫 <span id="chipTeacher">-</span></span>
      <span class="chip">🗂️ <span id="chipAid">-</span></span>
      <span class="chip">🧑‍🎓 <span id="chipStudent">-</span></span>
      <button id="editIdsBtn" class="btn">✏️ 編集</button>
    </div>
    <div class="status">
      <span class="label">保存状況:</span>
      <span id="saveDot" class="dot saved" title="保存済み"></span>
      <span id="saveText" class="label">保存済み</span>
    </div>
  </div>

  <!-- 下段：ツール -->
  <div class="bar" id="barTools">
    <div class="group">
      <button id="penBtn" class="btn active">✒️ ペン</button>
      <button id="eraserBtn" class="btn">🧽 消しゴム</button>
      <div class="sep"></div>
      <label class="label">太さ <input id="size" type="range" min="1" max="30" value="4"></label>
      <label class="label">色 <input id="color" type="color" value="#111111"></label>
      <div class="palette" id="palette">
        <button data-color="#000000" style="background:#000000"></button>
        <button data-color="#ff0000" style="background:#ff0000"></button>
        <button data-color="#0000ff" style="background:#0000ff"></button>
        <button data-color="#008000" style="background:#008000"></button>
        <button data-color="#ffa500" style="background:#ffa500"></button>
        <button data-color="#ffff00" style="background:#ffff00"></button>
      </div>
      <div class="sep"></div>
      <button id="textBtn" class="btn">T テキスト</button>
      <label class="label">文字 <input id="fontSize" type="number" min="10" max="96" value="18" style="width:4.5rem"></label>
    </div>
    <div class="group">
      <button id="handBtn" class="btn">✋ 移動</button>
      <button id="scrollUpBtn" class="btn" title="上へスクロール">▲</button>
      <button id="scrollDownBtn" class="btn" title="下へスクロール">▼</button>
      <div class="sep"></div>
      <div class="zoom">
        <button id="zoomOut" class="btn">−</button>
        <button id="zoomReset" class="btn">100%</button>
        <button id="zoomIn" class="btn">＋</button>
      </div>
      <div class="sep"></div>
      <button id="prevPage" class="btn">◀</button>
      <span id="pageInfo" class="label">-/-</span>
      <button id="nextPage" class="btn">▶</button>
    </div>
    <div class="group">
      <button id="undoBtn" class="btn">↶ Undo</button>
      <button id="redoBtn" class="btn">↷ Redo</button>
      <button id="clearBtn" class="btn">🗑 全消去</button>
      <button id="savePNGBtn" class="btn">🖼 PNG</button>
      <label class="label"><input type="checkbox" id="penOnly"> ペンのみ</label>
    </div>
    <span class="hint">（書き込みは1秒後に自動保存→再読込で復元）</span>
  </div>

  <div id="stageWrap">
    <canvas id="pdfLayer"></canvas>
    <canvas id="inkLayer"></canvas>
    <div id="textLayer"></div>
  </div>
</div>

<!-- IDs編集 -->
<dialog id="idsDlg">
  <form method="dialog" id="idsForm">
    <h3>IDの編集</h3>
    <div class="row">
      <label>先生ID <input id="idTeacher" type="text" required></label>
      <label>課題ID <input id="idAid" type="text" required></label>
    </div>
    <div class="row">
      <label>生徒ID <input id="idStudent" type="text" required></label>
      <label>APP_KEY <input id="idKey" type="text" placeholder="（必要なら変更）"></label>
    </div>
    <menu>
      <button value="cancel">キャンセル</button>
      <button id="idsSave" value="default">保存</button>
    </menu>
  </form>
</dialog>

<!-- 一括作成 -->
<dialog id="batchDlg">
  <form method="dialog" id="batchForm">
    <h3>生徒用リンクを一括作成</h3>
    <div class="row3">
      <label>人数 <input id="bCount" type="number" min="1" max="200" value="10"></label>
      <label>開始番号 <input id="bStart" type="number" min="0" max="99999" value="1"></label>
      <label>桁数 <input id="bDigits" type="number" min="1" max="6" value="3"></label>
    </div>
    <div class="row">
      <label>生徒IDプレフィックス <input id="bPrefix" type="text" value="s"></label>
      <label>（確認）先生ID <input id="bTeacher" type="text"></label>
    </div>
    <div class="row">
      <label>（確認）課題ID <input id="bAid" type="text"></label>
      <label>現在のPDF URL <input id="bPdf" type="text" disabled></label>
    </div>
    <div id="bWarn" class="warn" style="display:none">※先に「📤公開」または「🌐URL読込」でPDFをセットしてください。</div>
    <menu>
      <button value="cancel">閉じる</button>
      <button id="bGenerate" value="default">生成</button>
    </menu>
    <textarea id="bOutput" placeholder="ここにURL一覧が表示されます" style="display:none"></textarea>
    <menu id="bActions" style="display:none">
      <button id="bCopy" type="button">全コピー</button>
      <button id="bDownload" type="button">CSVダウンロード</button>
    </menu>
  </form>
</dialog>

<script type="module">
/* ====== 設定 ====== */
import * as pdfjsLib from './build/pdf.mjs';
pdfjsLib.GlobalWorkerOptions.workerSrc = './build/pdf.worker.mjs';

const UPLOAD_ENDPOINT = 'https://pdf-uploader-plain-union-c1fe.kkimura.workers.dev';
const SAVE_ENDPOINT   = UPLOAD_ENDPOINT;
const APP_KEY_PROMPT  = '先生用キー（APP_KEY）を入力してください';
const AUTO_OPEN_AFTER_UPLOAD = true;
const COPY_LINK_AFTER_UPLOAD = true;

/* 初期表示（中央寄せ＆ちょい拡大）のパラメータ */
const INITIAL_FIT = 'fit-width';   // 'fit-width' | 'fit-height' | 'fit-page'
const INITIAL_SCALE_BONUS = 1.15;  // 1.0より大きいと「少し大きめ」

/* ====== 参照 ====== */
const dpr = window.devicePixelRatio||1;
const pdfCanvas = document.getElementById('pdfLayer');
const inkCanvas = document.getElementById('inkLayer');
const textLayer = document.getElementById('textLayer');
const pdfCtx = pdfCanvas.getContext('2d');
const inkCtx = inkCanvas.getContext('2d');
const stageWrap = document.getElementById('stageWrap');
const $ = id=>document.getElementById(id);
const SCROLL_STEP = 300;

const ui = {
  penBtn:$('penBtn'), eraserBtn:$('eraserBtn'), textBtn:$('textBtn'), handBtn:$('handBtn'),
  scrollUpBtn:$('scrollUpBtn'), scrollDownBtn:$('scrollDownBtn'),
  size:$('size'), color:$('color'), fontSize:$('fontSize'),
  paletteWrap:$('palette'), paletteBtns:document.querySelectorAll('#palette button'),
  undoBtn:$('undoBtn'), redoBtn:$('redoBtn'), clearBtn:$('clearBtn'), penOnly:$('penOnly'),
  prev:$('prevPage'), next:$('nextPage'), info:$('pageInfo'), savePNGBtn:$('savePNGBtn'),
  uploadPdfBtn:$('uploadPdfBtn'), uploadPdfFile:$('uploadPdfFile'), openPdfUrlBtn:$('openPdfUrlBtn'),
  copyShareBtn:$('copyShareBtn'), batchLinksBtn:$('batchLinksBtn'),
  chipTeacher:$('chipTeacher'), chipAid:$('chipAid'), chipStudent:$('chipStudent'),
  editIdsBtn:$('editIdsBtn'), saveDot:$('saveDot'), saveText:$('saveText'),
  zoomIn:$('zoomIn'), zoomOut:$('zoomOut'), zoomReset:$('zoomReset'),
  // dialogs
  idsDlg:$('idsDlg'), idTeacher:$('idTeacher'), idAid:$('idAid'), idStudent:$('idStudent'),
  idKey:$('idKey'), idsSave:$('idsSave'),
  batchDlg:$('batchDlg'), bCount:$('bCount'), bStart:$('bStart'), bDigits:$('bDigits'),
  bPrefix:$('bPrefix'), bTeacher:$('bTeacher'), bAid:$('bAid'), bPdf:$('bPdf'),
  bGenerate:$('bGenerate'), bWarn:$('bWarn'), bOutput:$('bOutput'), bCopy:$('bCopy'), bDownload:$('bDownload'), bActions:$('bActions'),
};

/* ====== ダイアログ安全オープン ====== */
function openModalSafe(dlg){
  try{ if(typeof dlg.showModal==='function') dlg.showModal(); else dlg.show(); }
  catch{ dlg.show(); }
}
[ui.batchDlg, ui.idsDlg].forEach(dlg=>{
  if(!dlg) return;
  dlg.addEventListener('cancel', (e)=>{ e.preventDefault(); dlg.close(); });
  dlg.addEventListener('click', (e)=>{
    const r = dlg.getBoundingClientRect();
    const inside = e.clientX>=r.left && e.clientX<=r.right && e.clientY<=r.bottom && e.clientY>=r.top;
    if(!inside) dlg.close();
  });
});
window.addEventListener('pageshow', ()=>{ [ui.batchDlg, ui.idsDlg].forEach(d=>{ try{ d.close(); }catch{} }); });

/* ====== ユーティリティ ====== */
function toHexColor(c){
  if(!c) return '#111111';
  c=String(c).trim().toLowerCase();
  if(c.startsWith('#')){ if(c.length===4){const r=c[1],g=c[2],b=c[3]; return `#${r}${r}${g}${g}${b}${b}`;} return c.slice(0,7); }
  const m=c.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/);
  if(m){ const to2=n=>Math.max(0,Math.min(255,parseInt(n,10))).toString(16).padStart(2,'0'); return `#${to2(m[1])}${to2(m[2])}${to2(m[3])}`; }
  const NAME={black:'#000000',white:'#ffffff',red:'#ff0000',blue:'#0000ff',green:'#008000',yellow:'#ffff00',orange:'#ffa500',gray:'#808080',grey:'#808080'};
  return NAME[c]||'#111111';
}
function copyText(t){ return navigator.clipboard.writeText(t).catch(()=>{ prompt('この文字列をコピーしてください', t); }); }
function pad(n,d){return String(Number(n)||0).padStart(d,'0');}

/* 初期スケールの計算 */
function fitScaleForPage(mode){
  const sw = stageWrap.clientWidth || 1;
  const sh = stageWrap.clientHeight || 1;
  const pw = state.baseWidth  || 1;
  const ph = state.baseHeight || 1;

  const sW = sw / pw;
  const sH = sh / ph;

  let s;
  if(mode === 'fit-height') s = sH;
  else if(mode === 'fit-page') s = Math.min(sW, sH);
  else s = sW; // 幅基準

  s = s * (INITIAL_SCALE_BONUS || 1);
  return Math.max(0.1, Math.min(3, s));
}
/* 中央へスクロール */
function centerView(){
  const contentW = contentWidth()  * state.scale;
  const contentH = contentHeight() * state.scale;
  const targetLeft = Math.max(0, (contentW - stageWrap.clientWidth ) / 2);
  const targetTop  = Math.max(0, (contentH - stageWrap.clientHeight) / 2);
  stageWrap.scrollLeft = targetLeft;
  stageWrap.scrollTop  = targetTop;
}

/* ====== 状態 ====== */
const state = {
  tool:'pen', color:toHexColor(ui.color.value), size:+ui.size.value,
  drawing:false, last:null, stroke:[], history:[], redoStack:[],
  pdf:null, page:1, totalPages:0,
  scale:1, baseWidth:0, baseHeight:0,
  margin:0,              /* 余白ゼロ */
  pdfOffsetX:0, pdfOffsetY:0,
  texts:[],
  isPinching:false, touches:new Map(), lastCenter:null, lastDist:0, rafScheduled:false,
  isHandPanning:false, handStart:{x:0,y:0,sl:0,st:0},
  renderTask:null, renderSeq:0,
  activePointerId:null, activePointerType:null,
  penOnly:false,
  currentPdfUrl:null,
  saving:'saved'
};

/* ====== ID管理 ====== */
let teacherId, assignmentId, studentId;
function refreshChips(){
  ui.chipTeacher.textContent = teacherId || '-';
  ui.chipAid.textContent     = assignmentId || '-';
  ui.chipStudent.textContent = studentId || '-';
}
function ensureIDs(){
  const q = new URLSearchParams(location.search);
  teacherId    = q.get('t') || localStorage.getItem('teacherId') || prompt('先生名（略号）','tanaka');
  assignmentId = q.get('a') || localStorage.getItem('aid')       || prompt('課題コード','ws1');
  studentId    = q.get('s') || localStorage.getItem('studentId') || prompt('生徒ID（学籍番号など）','s001');
  localStorage.setItem('teacherId', teacherId);
  localStorage.setItem('aid', assignmentId);
  localStorage.setItem('studentId', studentId);
  refreshChips();
}
ensureIDs();
ui.editIdsBtn.onclick = ()=>{
  $('idTeacher').value = teacherId || '';
  $('idAid').value     = assignmentId || '';
  $('idStudent').value = studentId || '';
  $('idKey').value     = localStorage.getItem('APP_KEY') || '';
  openModalSafe(ui.idsDlg);
};
$('idsSave').onclick = (e)=>{
  e.preventDefault();
  teacherId = $('idTeacher').value.trim();
  assignmentId = $('idAid').value.trim();
  studentId = $('idStudent').value.trim();
  const key = $('idKey').value.trim();
  if(key) localStorage.setItem('APP_KEY', key);
  localStorage.setItem('teacherId', teacherId);
  localStorage.setItem('aid', assignmentId);
  localStorage.setItem('studentId', studentId);
  refreshChips();
  ui.idsDlg.close();
};

/* ====== 保存インジケーター ====== */
function setSaveStatus(s){
  state.saving = s;
  ui.saveDot.className = 'dot ' + (s==='saving'?'saving':s==='error'?'error':'saved');
  ui.saveText.textContent = s==='saving'?'保存中…': s==='error'?'保存エラー':'保存済み';
}

/* ====== ツール切替 ====== */
function setActiveTool(tool){
  state.tool=tool;
  const map={pen:ui.penBtn,eraser:ui.eraserBtn,text:ui.textBtn,hand:ui.handBtn};
  [ui.penBtn,ui.eraserBtn,ui.textBtn,ui.handBtn].forEach(b=>{
    const on=b===map[tool]; b.classList.toggle('active',on); b.setAttribute('aria-pressed',String(on));
  });
  textLayer.style.pointerEvents = (tool==='text')?'auto':'none';
  stageWrap.classList.toggle('grabbing', tool==='hand' && state.isHandPanning);

  // 移動ツール時：指はネイティブスクロール可
  if(tool==='hand'){
    pdfCanvas.style.touchAction = 'pan-x pan-y';
    inkCanvas.style.touchAction = 'pan-x pan-y';
  }else{
    pdfCanvas.style.touchAction = 'none';
    inkCanvas.style.touchAction = 'none';
  }
}
setActiveTool('pen');

function setSelectedPalette(color){
  const hex=toHexColor(color);
  state.color=hex; ui.color.value=hex;
  for(const b of ui.paletteBtns){ b.classList.toggle('sel', b.dataset.color?.toLowerCase()===hex.toLowerCase()); }
  const sel=document.querySelector('.textbox.sel'); if(sel){ sel.style.color=hex; sel.dataset.color=hex; }
}
setSelectedPalette(ui.color.value);

/* ====== レイアウト/描画 ====== */
function ensureBaseSize(){ if(state.baseWidth && state.baseHeight) return; const cssW=Math.max(600, stageWrap.clientWidth||800); const cssH=Math.round(cssW*1.41421356); state.baseWidth=cssW; state.baseHeight=cssH; }
function contentWidth(){ return state.baseWidth + state.margin*2; }
function contentHeight(){ return state.baseHeight + state.margin*2; }
async function drawPage(){
  ensureBaseSize();
  if(state.renderTask){ try{ state.renderTask.cancel(); }catch{} state.renderTask=null; }
  const seq = ++state.renderSeq;

  if(state.pdf){
    const page = await state.pdf.getPage(state.page);
    const v1 = page.getViewport({scale:1});
    state.baseWidth=v1.width; state.baseHeight=v1.height;
  }
  const W = contentWidth()*state.scale, H = contentHeight()*state.scale;
  pdfCanvas.width=Math.round(W*dpr); pdfCanvas.height=Math.round(H*dpr);
  inkCanvas.width=pdfCanvas.width;   inkCanvas.height=pdfCanvas.height;
  pdfCanvas.style.width=W+'px'; pdfCanvas.style.height=H+'px';
  inkCanvas.style.width=W+'px';   inkCanvas.style.height=H+'px';
  textLayer.style.width=W+'px';   textLayer.style.height=H+'px';

  pdfCtx.setTransform(dpr,0,0,dpr,0,0);
  pdfCtx.fillStyle='#ffffff';
  pdfCtx.fillRect(0,0,pdfCanvas.width/dpr,pdfCanvas.height/dpr);

  if(state.pdf){
    const page = await state.pdf.getPage(state.page);
    const v = page.getViewport({scale:state.scale});
    const offsetX = state.margin*state.scale;
    const offsetY = state.margin*state.scale;
    state.pdfOffsetX = state.margin; state.pdfOffsetY = state.margin;

    pdfCtx.save();
    pdfCtx.translate(offsetX, offsetY);
    try{
      const task = page.render({canvasContext:pdfCtx, viewport:v});
      state.renderTask = task;
      await task.promise;
      if(seq!==state.renderSeq) return;
    }catch(e){} finally{ if(seq===state.renderSeq) state.renderTask=null; pdfCtx.restore(); }
    ui.info.textContent=`${state.page}/${state.totalPages}`;
  }else{
    ui.info.textContent='—/—';
  }
  redrawInk();
  layoutTextboxes();
}
function scheduleDrawThrottle(){ if(state.rafScheduled) return; state.rafScheduled=true; requestAnimationFrame(()=>{ state.rafScheduled=false; drawPage(); }); }

/* ====== Ink描画 ====== */
const scaled = p=>({x:p.x*state.scale, y:p.y*state.scale, pres:p.pres});
function drawLine(ctx,a,b,opt){ const pressure=b.pres??1, base=opt.size||state.size; const w=opt.pressure? base*pressure: base; ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle=opt.color||state.color; ctx.lineWidth=w; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); }
function eraseLine(ctx,a,b,esize){ ctx.save(); ctx.globalCompositeOperation='destination-out'; drawLine(ctx,a,b,{color:'#000', size:esize||state.size*3, pressure:true}); ctx.restore(); }
function getLogicalPos(e){ const r=inkCanvas.getBoundingClientRect(); return {x:(e.clientX-r.left)/state.scale, y:(e.clientY-r.top)/state.scale, pres:e.pressure>0?e.pressure:1}; }
function begin(p){ state.drawing=true; state.last=p; state.stroke=[{p,tool:state.tool,color:state.color,size:state.size}]; }
function move(p){ if(!state.drawing) return; const a=state.last,b=p, As=scaled(a), Bs=scaled(b); if(state.tool==='pen') drawLine(inkCtx,As,Bs,{pressure:true,size:state.size*state.scale,color:state.color}); else eraseLine(inkCtx,As,Bs,(state.size*3)*state.scale); state.stroke.push({p,tool:state.tool,color:state.color,size:state.size}); state.last=b; }
function end(){ if(!state.drawing) return; state.drawing=false; state.history.push({ops:state.stroke, page: state.pdf?state.page:1}); state.redoStack=[]; scheduleNoteSave(); }
function redrawInk(){
  inkCtx.setTransform(dpr,0,0,dpr,0,0);
  inkCtx.clearRect(0,0,inkCanvas.width/dpr,inkCanvas.height/dpr);
  const curr = String(state.pdf?state.page:1);
  for(const h of state.history){
    if(String(h.page||1)!==curr) continue;
    for(let i=1;i<h.ops.length;i++){
      const A=h.ops[i-1],B=h.ops[i]; const a=scaled(A.p), b=scaled(B.p);
      if(B.tool==='pen') drawLine(inkCtx,a,b,{color:A.color,size:(A.size||state.size)*state.scale});
      else eraseLine(inkCtx,a,b,((A.size||state.size)*3)*state.scale);
    }
  }
}

/* ====== テキスト ====== */
function layoutTextboxes(){
  const curr=String(state.pdf?state.page:1);
  for(const t of state.texts){
    const onThisPage = String(t.page||1)===curr;
    t.el.style.display = onThisPage ? 'block' : 'none';
    if(!onThisPage) continue;
    t.el.style.left=(t.x*state.scale)+'px';
    t.el.style.top =(t.y*state.scale)+'px';
    t.el.style.fontSize=(t.fontSize*state.scale)+'px';
    t.el.style.color=t.color;
  }
}
function createTextbox(xCss,yCss,opts={}){
  const lx=xCss/state.scale, ly=yCss/state.scale;
  const el=document.createElement('div'); el.className='textbox sel'; el.contentEditable='true'; el.spellcheck=false;
  const color=toHexColor(opts.color||state.color); const fontSize=(opts.fontSize||+ui.fontSize.value);
  const pageIndex = state.pdf?state.page:1;
  const item={el,x:lx,y:ly,fontSize,color,page:pageIndex}; state.texts.push(item);
  el.style.left=(lx*state.scale)+'px'; el.style.top=(ly*state.scale)+'px';
  el.style.fontSize=(fontSize*state.scale)+'px'; el.style.color=color;
  el.dataset.color=color; el.dataset.fontSize=String(fontSize); el.dataset.page=String(pageIndex);
  el.addEventListener('focus',()=>selectTextbox(item));
  el.addEventListener('blur',()=>{ el.classList.remove('sel'); scheduleNoteSave(); });
  el.addEventListener('input',()=> scheduleNoteSave());
  el.addEventListener('keydown',(e)=>{ if((e.key==='Backspace'||e.key==='Delete') && el.textContent===''){ e.preventDefault(); removeTextbox(item); scheduleNoteSave(); } });
  let dragging=false,sx=0,sy=0;
  el.addEventListener('pointerdown',(e)=>{ dragging=true; el.setPointerCapture(e.pointerId); sx=e.clientX; sy=e.clientY; selectTextbox(item); });
  el.addEventListener('pointermove',(e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; item.x+=dx/state.scale; item.y+=dy/state.scale; el.style.left=(item.x*state.scale)+'px'; el.style.top=(item.y*state.scale)+'px'; sx=e.clientX; sy=e.clientY; });
  ['pointerup','pointercancel','pointerleave','pointerout'].forEach(t=> el.addEventListener(t, ()=> dragging=false ));
  textLayer.appendChild(el);
  return item;
}
function selectTextbox(item){ document.querySelectorAll('.textbox.sel').forEach(n=>n.classList.remove('sel')); item.el.classList.add('sel'); ui.color.value=item.color; setSelectedPalette(item.color); ui.fontSize.value=String(item.fontSize); }
function removeTextbox(item){ const i=state.texts.indexOf(item); if(i>=0) state.texts.splice(i,1); item.el.remove(); }

/* ====== UI events ====== */
ui.penBtn.onclick=()=>setActiveTool('pen');
ui.eraserBtn.onclick=()=>setActiveTool('eraser');
ui.textBtn.onclick=()=>setActiveTool('text');
ui.handBtn.onclick=()=>setActiveTool('hand');

ui.scrollUpBtn.onclick   = ()=> stageWrap.scrollBy({top:-SCROLL_STEP, behavior:'smooth'});
ui.scrollDownBtn.onclick = ()=> stageWrap.scrollBy({top: SCROLL_STEP, behavior:'smooth'});

ui.color.addEventListener('input', ()=> setSelectedPalette(ui.color.value));
ui.paletteWrap.addEventListener('click',(e)=>{ const b=e.target.closest('button[data-color]'); if(!b) return; setSelectedPalette(b.dataset.color); });
ui.size.addEventListener('input', ()=> state.size=+ui.size.value);
ui.fontSize.addEventListener('input', ()=>{ const sel=document.querySelector('.textbox.sel'); if(!sel) return; const item=state.texts.find(t=>t.el===sel); if(!item) return; item.fontSize=+ui.fontSize.value; layoutTextboxes(); scheduleNoteSave(); });

ui.undoBtn.onclick=()=>{ if(state.history.length){ state.redoStack.push(state.history.pop()); redrawInk(); scheduleNoteSave(); } };
ui.redoBtn.onclick=()=>{ if(state.redoStack.length){ state.history.push(state.redoStack.pop()); redrawInk(); scheduleNoteSave(); } };
ui.clearBtn.onclick=()=>{ if(confirm('全消去しますか？')){ state.history=[]; state.redoStack=[]; inkCtx.setTransform(dpr,0,0,dpr,0,0); inkCtx.clearRect(0,0,inkCanvas.width/dpr,inkCanvas.height/dpr); for(const t of state.texts)t.el.remove(); state.texts=[]; scheduleNoteSave(); } };

ui.prev.onclick=()=>{ if(state.pdf && state.page>1){ state.page--; drawPage(); } };
ui.next.onclick=()=>{ if(state.pdf && state.page<state.totalPages){ state.page++; drawPage(); } };

$('zoomIn').onclick = ()=>{ state.scale=Math.min(3, state.scale*1.2); drawPage(); centerView(); };
$('zoomOut').onclick= ()=>{ state.scale=Math.max(0.5, state.scale/1.2); drawPage(); centerView(); };
$('zoomReset').onclick= ()=>{ state.scale=fitScaleForPage(INITIAL_FIT); drawPage(); centerView(); };

/* ====== 手ツール：スクロール（マウスは自前、指はネイティブ） ====== */
function canHandPanPointer(e){
  if(state.isPinching) return false;
  if(state.tool!=='hand') return false;
  if(e && e.pointerType==='touch') return false; // 指はネイティブ
  return true;
}
stageWrap.addEventListener('pointerdown', e=>{
  if(!canHandPanPointer(e)) return;
  state.isHandPanning = true;
  stageWrap.classList.add('grabbing');
  state.handStart = { x:e.clientX, y:e.clientY, sl:stageWrap.scrollLeft, st:stageWrap.scrollTop };
  try{ stageWrap.setPointerCapture(e.pointerId); }catch{}
});
stageWrap.addEventListener('pointermove', e=>{
  if(!state.isHandPanning) return;
  const dx = e.clientX - state.handStart.x;
  const dy = e.clientY - state.handStart.y;
  stageWrap.scrollLeft = state.handStart.sl - dx;
  stageWrap.scrollTop  = state.handStart.st - dy;
});
['pointerup','pointercancel','pointerleave','pointerout'].forEach(t=>{
  stageWrap.addEventListener(t, ()=>{
    if(state.isHandPanning){
      state.isHandPanning=false;
      stageWrap.classList.remove('grabbing');
    }
  });
});

/* ====== Ink 入力 ====== */
function isPenLike(e){ const isPen = e.pointerType === 'pen'; const isMouseOnNonTouchPC = (e.pointerType === 'mouse' && (navigator.maxTouchPoints||0) === 0); return isPen || isMouseOnNonTouchPC; }
inkCanvas.addEventListener('pointerdown', e => { if (state.isPinching) return; if (state.tool !== 'pen' && state.tool !== 'eraser') return; if (state.penOnly && !isPenLike(e)) return; if (state.activePointerId !== null && state.activePointerId !== e.pointerId) return; state.activePointerId = e.pointerId; state.activePointerType = e.pointerType; try { inkCanvas.setPointerCapture(e.pointerId); } catch {} begin(getLogicalPos(e)); });
inkCanvas.addEventListener('pointermove', e => { if (state.isPinching) return; if (state.activePointerId === null || e.pointerId !== state.activePointerId) return; if (state.tool !== 'pen' && state.tool !== 'eraser') return; if (state.penOnly && !isPenLike(e)) return; if (state.drawing) move(getLogicalPos(e)); });
['pointerup','pointercancel','pointerout','pointerleave'].forEach(t=> inkCanvas.addEventListener(t, (e)=>{ if (state.activePointerId !== null && e.pointerId === state.activePointerId){ end(); state.activePointerId=null; state.activePointerType=null; } }));
ui.penOnly.addEventListener('change', e=>{ state.penOnly = e.target.checked; if (state.penOnly && state.activePointerType !== 'pen') { state.activePointerId=null; state.activePointerType=null; state.drawing=false; } });

/* ====== ピンチズーム（2本指） ====== */
function pointerPos(e){ return {x:e.clientX, y:e.clientY}; }
function onTouchPointersChanged(){ const touches=[...state.touches.values()]; if(touches.length>=2){ state.isPinching=true; const [a,b]=touches; const dx=b.x-a.x, dy=b.y-a.y; state.lastDist=Math.hypot(dx,dy); state.lastCenter={x:(a.x+b.x)/2, y:(a.y+b.y)/2}; } else { state.isPinching=false; } }
stageWrap.addEventListener('pointerdown', e=>{ if(e.pointerType==='touch'){ state.touches.set(e.pointerId, pointerPos(e)); onTouchPointersChanged(); } });
stageWrap.addEventListener('pointermove', e=>{
  if(e.pointerType==='touch' && state.touches.has(e.pointerId)){
    state.touches.set(e.pointerId, pointerPos(e));
    if(state.touches.size>=2){
      const t=[...state.touches.values()];
      const [a,b]=t; const dx=b.x-a.x, dy=b.y-a.y;
      const newDist=Math.hypot(dx,dy);
      const center={x:(a.x+b.x)/2, y:(a.y+b.y)/2};
      const delta=newDist/(state.lastDist||newDist);

      const rect=stageWrap.getBoundingClientRect();
      const cx = center.x - rect.left + stageWrap.scrollLeft;
      const cy = center.y - rect.top  + stageWrap.scrollTop;

      if(delta>1.01 || delta<0.99){
        const oldScale=state.scale;
        const newScale=Math.min(3, Math.max(0.5, oldScale*delta));
        if(newScale!==oldScale){
          state.scale=newScale;
          scheduleDrawThrottle();
          const factor=newScale/oldScale;
          stageWrap.scrollLeft = Math.max(0, cx*factor - (center.x - rect.left));
          stageWrap.scrollTop  = Math.max(0, cy*factor - (center.y - rect.top));
        }
      }else{
        const dxCenter = center.x - (state.lastCenter?.x ?? center.x);
        const dyCenter = center.y - (state.lastCenter?.y ?? center.y);
        stageWrap.scrollLeft -= dxCenter;
        stageWrap.scrollTop  -= dyCenter;
      }
      state.lastDist=newDist; state.lastCenter=center;
      e.preventDefault();
    }
  }
});
['pointerup','pointercancel','pointerleave','pointerout'].forEach(type=> stageWrap.addEventListener(type, e=>{ if(e.pointerType==='touch'){ state.touches.delete(e.pointerId); onTouchPointersChanged(); } }));

/* ====== PNG（見た目合成） ====== */
function exportPNG(){
  const out=document.createElement('canvas'); out.width=pdfCanvas.width; out.height=pdfCanvas.height;
  const o=out.getContext('2d'); o.drawImage(pdfCanvas,0,0); o.drawImage(inkCanvas,0,0);
  const curr=String(state.pdf?state.page:1); o.textBaseline='top';
  for(const t of state.texts){
    if(String(t.page||1)!==curr) continue;
    const x=t.x*state.scale*dpr, y=t.y*state.scale*dpr, fontPx=Math.round(t.fontSize*state.scale*dpr);
    o.fillStyle=t.color;
    o.font=`${fontPx}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif`;
    const lines=(t.el.innerText||'').replace(/\r/g,'').split('\n');
    const lh=Math.round(t.fontSize*1.3*state.scale*dpr);
    for(let i=0;i<lines.length;i++){ o.fillText(lines[i], x, y+i*lh); }
  }
  const a=document.createElement('a'); a.href=out.toDataURL('image/png'); a.download=`note_page${state.pdf?state.page:1}.png`; a.click();
}
ui.savePNGBtn.onclick = exportPNG;

/* ====== ノート保存/復元 ====== */
let saveTimer=null;
function scheduleNoteSave(){ clearTimeout(saveTimer); saveTimer=setTimeout(saveNoteNow, 1000); setSaveStatus('saving'); }
async function saveNoteNow(){
  const key = localStorage.getItem('APP_KEY') || prompt(APP_KEY_PROMPT) || '';
  if(!key){ setSaveStatus('error'); return; }
  localStorage.setItem('APP_KEY', key);
  const snap = makeNoteSnapshot();
  try{
    const r = await fetch(`${SAVE_ENDPOINT}?op=note`, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-App-Key': key,
        'X-Op':'note',
        'X-Teacher': teacherId,
        'X-Aid': assignmentId,
        'X-Student': studentId
      },
      body: JSON.stringify(snap)
    });
    if(!r.ok){ setSaveStatus('error'); console.warn('save failed', r.status, await r.text()); }
    else setSaveStatus('saved');
  }catch(e){ setSaveStatus('error'); console.warn('save error', e); }
}
function makeNoteSnapshot(){
  const strokes = state.history.map(h=>({
    page: h.page || 1,
    tool: h.ops[0]?.tool || 'pen',
    color: h.ops[0]?.color || state.color,
    size:  h.ops[0]?.size  || state.size,
    points: h.ops.map(o=>[o.p.x, o.p.y, o.p.pres ?? 1])
  }));
  const texts = state.texts.map(t=>({
    page: t.page || Number(t.el.dataset.page||1),
    x: t.x, y: t.y, fontSize: t.fontSize, color: t.color,
    text: t.el.innerText || ''
  }));
  return { noteV:1, strokes, texts };
}
function applyNoteSnapshot(snap){
  state.history = [];
  for(const s of (snap.strokes||[])){
    const ops = s.points.map(p=>({ p:{x:p[0], y:p[1], pres:p[2]??1}, tool:s.tool, color:s.color, size:s.size }));
    state.history.push({ ops, page:s.page||1 });
  }
  redrawInk();
  for(const t of [...state.texts]) t.el.remove();
  state.texts=[];
  for(const t of (snap.texts||[])){
    const item = createTextbox(t.x*state.scale, t.y*state.scale, {fontSize:t.fontSize, color:t.color});
    item.x=t.x; item.y=t.y; item.fontSize=t.fontSize; item.color=t.color;
    item.page = t.page||1; item.el.dataset.page=String(item.page);
    item.el.textContent = t.text||'';
  }
  layoutTextboxes();
}
async function loadNoteIfAny(){
  const key = localStorage.getItem('APP_KEY') || prompt(APP_KEY_PROMPT) || '';
  if(!key) return; localStorage.setItem('APP_KEY', key);
  try{
    const u = new URL(SAVE_ENDPOINT);
    u.searchParams.set('op','note');
    u.searchParams.set('teacher', teacherId);
    u.searchParams.set('aid', assignmentId);
    u.searchParams.set('student', studentId);
    u.searchParams.set('key', key);
    const r = await fetch(u.toString(), { method:'GET' });
    if(!r.ok) return;
    const j = await r.json();
    if(j && j.ok && j.note) applyNoteSnapshot(j.note);
  }catch(e){ console.warn('load note err', e); }
}

/* ====== PDF URL読込・共有 ====== */
function buildShareUrl(pdfUrl, overrideStudentId){
  const base = location.origin + location.pathname;
  const q = new URLSearchParams();
  q.set('pdf', pdfUrl);
  q.set('t', teacherId); q.set('a', assignmentId); q.set('s', overrideStudentId ?? studentId);
  return `${base}?${q.toString()}`;
}
/* ★ 読み込み：初期スケール＆中央寄せを適用 */
async function loadPdfFromUrl(url){
  try{
    const res = await fetch(url, {mode:'cors'});
    if(!res.ok) throw new Error('fetch fail');
    const buf = await res.arrayBuffer();

    // PDFを準備
    state.pdf = await pdfjsLib.getDocument({data:buf}).promise;
    state.totalPages = state.pdf.numPages;
    state.page = 1;
    state.currentPdfUrl = url;

    // 初期スケールのための素サイズを取得
    try{
      const page1 = await state.pdf.getPage(1);
      const v1    = page1.getViewport({scale:1});
      state.baseWidth  = v1.width;
      state.baseHeight = v1.height;
    }catch{}

    // 初期スケール（幅基準＋少し大きめが既定）
    state.scale = fitScaleForPage(INITIAL_FIT);

    // URLクエリを置換（共有URLの土台維持）
    const qs = new URLSearchParams(location.search);
    qs.set('pdf', url); qs.set('t', teacherId); qs.set('a', assignmentId); qs.set('s', studentId);
    history.replaceState(null,'', location.pathname + '?' + qs.toString());

    // 描画→中央寄せ
    await drawPage();
    centerView();

  }catch(e){
    alert('PDFの読み込みに失敗しました');
    console.warn(e);
  }
}

ui.openPdfUrlBtn.onclick = async ()=>{
  const u = prompt('読み込むPDFのURL（raw.githubusercontent.com など）を入力');
  if(!u) return;
  await loadPdfFromUrl(u.trim());
};
ui.copyShareBtn.onclick = async ()=>{
  if(!state.currentPdfUrl){ alert('共有リンクを作るには、PDFをURLから読み込むか、GitHubに公開してください。'); return; }
  const link = buildShareUrl(state.currentPdfUrl);
  await copyText(link); alert('共有リンクをコピーしました');
};

/* ====== GitHub にPDF公開（Worker経由） ====== */
async function uploadPdfToGithub(file){
  if (file.size > 9.5 * 1024 * 1024) { alert('PDFが10MBを超えています'); return null; }
  const key = localStorage.getItem('APP_KEY') || prompt(APP_KEY_PROMPT) || '';
  if (!key) return null;
  localStorage.setItem('APP_KEY', key);

  let data;
  try{
    const res = await fetch(UPLOAD_ENDPOINT, {
      method:'POST',
      headers:{
        'Content-Type':'application/pdf',
        'X-App-Key': key,
        'X-Filename': file.name || 'worksheet.pdf',
        'X-Teacher': teacherId,
        'X-Aid': assignmentId
      },
      body:file
    });
    const txt = await res.text();
    try{ data = JSON.parse(txt); }catch{ throw new Error('Invalid JSON: '+txt); }
    if(!res.ok || !data.ok){ throw new Error(txt); }
  }catch(e){
    console.error('UPLOAD_ERROR', e);
    alert('アップロードに失敗: ' + String(e));
    return null;
  }

  const rawUrl = data.raw_url || data.rawUrl || data.download_url || data.downloadUrl || data.url || data.raw;
  if(!rawUrl){
    alert('アップロード成功。ただしURLが返りませんでした（Workerのレスポンスを確認）。');
    return null;
  }

  state.currentPdfUrl = rawUrl;
  const share = buildShareUrl(state.currentPdfUrl);

  // まず同タブ表示（失敗しても遷移でカバー）
  try{ await loadPdfFromUrl(state.currentPdfUrl); }catch(e){ console.warn('inline load failed', e); }

  // クリップボード保存（任意）
  if (COPY_LINK_AFTER_UPLOAD) { try { await navigator.clipboard.writeText(share); } catch {} }

  // 共有URLへ実遷移（履歴置換）
  if (AUTO_OPEN_AFTER_UPLOAD) { location.replace(share); return share; }

  alert('PDFを公開して読み込みました！');
  return state.currentPdfUrl;
}
ui.uploadPdfBtn.onclick = ()=> ui.uploadPdfFile.click();
ui.uploadPdfFile.onchange = async e=>{
  const f=e.target.files?.[0];
  if(!f) return;
  await uploadPdfToGithub(f);
  e.target.value='';
};

/* ====== 一括リンク作成 ====== */
ui.batchLinksBtn.onclick = ()=>{
  ui.bTeacher.value = teacherId; ui.bAid.value = assignmentId;
  ui.bPdf.value = state.currentPdfUrl || '';
  ui.bWarn.style.display = state.currentPdfUrl ? 'none' : 'block';
  ui.bOutput.style.display = 'none'; ui.bActions.style.display='none';
  openModalSafe(ui.batchDlg);
};
ui.bGenerate.addEventListener('click', (ev)=>{
  ev.preventDefault();
  if(!state.currentPdfUrl){ ui.bWarn.style.display='block'; return; }
  const count  = Math.max(1, Math.min(200, Number(ui.bCount.value)||10));
  const start  = Math.max(0, Math.min(99999, Number(ui.bStart.value)||1));
  const digits = Math.max(1, Math.min(6, Number(ui.bDigits.value)||3));
  const prefix = (ui.bPrefix.value||'s').trim();
  teacherId    = (ui.bTeacher.value||teacherId).trim(); localStorage.setItem('teacherId', teacherId);
  assignmentId = (ui.bAid.value||assignmentId).trim(); localStorage.setItem('aid', assignmentId);

  const lines=[];
  for(let i=0;i<count;i++){
    const sid = `${prefix}${pad(start+i, digits)}`;
    const link = buildShareUrl(state.currentPdfUrl, sid);
    lines.push(link);
  }
  ui.bOutput.value = lines.join('\n');
  ui.bOutput.style.display = 'block';
  ui.bActions.style.display = 'flex';
});
ui.bCopy.onclick = async ()=>{ try{ await navigator.clipboard.writeText(ui.bOutput.value); alert('一覧をコピーしました'); }catch{ prompt('この文字列をコピーしてください', ui.bOutput.value); } };
ui.bDownload.onclick = ()=>{
  const rows = ui.bOutput.value.split('\n').filter(Boolean).map(l=>{
    const u = new URL(l);
    return `${u.searchParams.get('s')},${l}`;
  });
  const csv = 'student_id,link\n' + rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${assignmentId}_${teacherId}_links.csv`;
  a.click();
};

/* ====== 自動PDF読込 ====== */
async function tryAutoLoadPDF(){
  const q = new URLSearchParams(location.search);
  const url = q.get('pdf');
  if(!url) return;
  state.currentPdfUrl = url;
  await loadPdfFromUrl(url);
}

/* ====== 初期化 ====== */
window.addEventListener('load', async ()=>{
  await drawPage();
  await tryAutoLoadPDF();
  await loadNoteIfAny();
});
window.addEventListener('resize', ()=>{ drawPage(); centerView(); } );
</script>
</body>
</html>
